const item2_10 = '994277,1433802,993837,993892,994045,994048,994051,993767,994239,997398,993755,993763,993770,993781,993890,993943,994043,994046,994049,994226,994237,995447,996979,996983,996991,996994,997019,997169,997280,997285,997301,1431286,1536459,996734,996976,996978,996981,996982,996988,997164,997165,997170,997284,997287,997296,1536457,1310202,1310212,1310270,857105,857113,857120,1442445,1495472,1495474,1495476,857370,857001,857004,857007,857136,858838,1492671,1492673,1492675,1147395,856942,856984,856991,856996,858772,858784,859331,856946,858780,859317,1860492,1860494,1860496,1860498,1860500,1860502,1542981,1542988,1595736,1595742,1595748,1595754,1595760,1595766,1595772,833036,856992,857005,857083,857118,857134,858798,860599,1044427,856903,856908,856940,856944,856962,856980,856987,856999,857002,857076,857099,857107,857111,857121,857128,857131,857383,857391,857501,858770,858778,859315,1860491,1595730,1595740,1595746,1860493,1860495,1860497,1860499,1860501,1595752,1595758,1595764,1595770,404414,1010603,1010606,1010608,1010609,1307058,1307063,904874,904878,904882,1432971,1542999,1864414,1431083,1431104,1597570,1597575,1666385,1542396,1544853,1544856,1716063,1716067,1716071,1716075,1716079,1716083,1716090,1797655,2106368,2058257,1864412,246474,250426,1010600,1010604,351264,351265,351266,351267,904870,904876,904880,1431076,1431102,1432969,1542390,1542997,1544851,1544854,1597568,1597573,1666338,1716057,1716065,1716069,1716073,1716077,1716081,1716086,1797650,1307056,1307061,250473,2046597,2046591,864737,864980,991149,864712,864708,864720,1990745,864706,864718,864761,864769,864984,991147,864978,836397,836395,999729,886634,250879,250880,1234976,1190201,1234990,1234957,2105929,1995536,1596108,1812164,1234871,1234872,1234941,1234978,1234999,1235009,1235011,1236179,1236182,1236184,1236188,1236190,1236239,1053651,1053654,1053657,1053660,1053663,1053666,1115575,1115579,1729322,261184,261185,261186,262071,583490,261106,261107,261108,261109,261110,262219,668622,668624,668626,668628,668630,1666837,1237055,1237059,1237062,1237066,1237070,1666831,1115573,1115577,1237050,1237060,1053652,1053655,1053658,197696,245134,245135,245136,310295,310296,310297,668364,668365,706898,858092,858095,1053647,668363,310292,1053664,310293,310294,313993,668367,858087,858101,1053661,313992,668366,858098,577057,1603495,1603498,1603501,1729320,1237057,1237064,1237068,897658,897698,897704,897712,902733,902738,902743,1306900,898611,898614,898618,897657,897696,897702,897710,897749,897771,898004,898138,898139,898612,898624,902729,902736,902741,1306898,1049589,861517,861525,861455,861467,861479,861578,1655058,1655060,106505,892496,892556,892560,892574,892598,892645,892648,892658,892660,894803,894805,894813,894816,1303738,892299,892344,892351,892357,863847,863849,863851,863853,863855,863857,1745881,1745886,1745889,1745892,1871440,1871443,1871446,894942,894970,895248,863848,863850,863852,891885,891888,892342,892345,892596,892603,892669,892672,892678,894801,895201,895221,895227,1871441,1872234,863845,863854,863856,891874,891883,891890,891893,892349,892352,892554,894814,895022,895247,1871444,891878,891881,892297,892355,892494,892516,892579,892582,892589,892625,892643,892646,894780,894807,894918,894986,895014,895016,895185,895199,895206,895208,895215,895217,895219,895233,895238,895240,895869,895871,1871434,895861,895867,1303736,1545903,1545907,1545910,1806707,1806701,1806710,1806716,1806722,1806728,1806734,312104,312107,830196,248477,1944535,1944540,1944543,1049216,1049223,1049227,1487288,1049504,1049545,1049565,1049576,1049586,1049595,1049601,1050409,1049582,1049613,1049620,1049623,1050490,1049625,1049637,1049640,1049642,1049647,1049650,1049655,848772,848928,1491834,1537116,1537120,1537122,1664448,1664634,1790533,1791560,1791569,1791576,1791582,2045500,247626,247627,248307,1944541,1014599,1014615,1014632,1049214,1049221,1049225,1049233,1049251,1049260,1049267,1049270,1049502,1049621,1049651,1049658,1049683,1049691,1049696,1049717,1049727,1113314,1491832,1860157,1037259,1049635,1944529,1944538,1049543,1049557,1049563,1049574,1049580,1049584,1049593,1049599,1049604,1049611,1049615,1049618,1049686,1049720,1049721,1860127,1860129,1860137,1860148,1860151,1860154,637540,724614,848768,1790527,1791558,1791567,1791574,1791580,2105822,199789,250486,250877,312289,250485,312288,827750,827748,827751,828576,828581,828585,828594,849279,849303,849304,849293,849295,849455,1149367,1149370,1149373,1149376,1149378,854140,854142,854144,1148800,1148803,1148807,1148797,1148809,825409,825411,825413,1356315,1148482,1148487,1148491,835605,845314,845315,845316,833710,833712,833714,849561,1148478,1148485,1148489,833709,833711,833713,835603,836408,836466,836485,849903,1248115,1946525,1946527,1946529,849331';
const item3_10 = '12478-4,78813-3,16212-3,19421-7,78754-9,67126-3,58358-3,8174-5,53743-1,19579-2,86606-1,79232-5,21557-4,79237-4,44424-0,67838-3,3779-6,18355-8,19569-3,58397-1,19578-4,19514-9,78847-1,14309-9,45143-5,19268-2,87492-5,72808-9,79234-1,78843-0,64127-4,19073-6,19565-1,14267-9,20410-7,61058-4,14310-7,19461-3,19554-5,73918-5,12292-9,14314-9,78849-7,18392-1,19556-0,3351-4,14312-3,3568-3,19572-7,72467-4,19288-0,78845-5,19580-0,3530-3,20519-5,3349-8,75651-0,45185-6,70143-3,72468-2,19684-0,80113-4,19511-5,72779-2,8151-3,72818-8,3901-6,19383-9,3635-0,72802-2,3936-2,3787-9,19292-2,19567-7,19263-3,19653-5,78841-4,72778-4,31025-0,72796-6,19405-0,19515-6,78839-8,86195-5,19425-8,70138-3,16235-4,76492-8,3565-9,72874-1,42241-0,79236-6,19346-6,19688-1,78844-8,19659-2,16226-3,13497-3,3564-2,8150-5,27085-0,78783-8,19348-2,19459-7,19363-1,3488-4,86192-2,19456-3,19384-7,82723-8,72466-6,19415-9,79241-6,72464-1,72809-7,15366-8,73998-7,77772-2,3435-5,15404-7,72825-3,79233-3,52951-1,19427-4,6930-2,8193-5,19660-0,20521-1,19566-9,59328-5,8238-8,52954-5,59928-2,14311-5,14315-6,77771-4,64138-1,78878-6,74000-1,78837-2,20558-3,79246-5,55587-0,18415-0,19287-2,3397-7,13478-3,16234-7,42253-5,19409-2,87486-7,14313-1,87494-1,87487-5,72461-7,72469-0,3394-4,19359-9,19555-2,19571-9,59844-1,86196-3,78850-5,20546-8,72471-6,78836-4,78879-4,16369-1,19416-7,18282-4,19510-7,19382-1,19055-3,33350-0,18358-2,50594-1,72807-1,20413-1,19458-9,19347-4,19512-3,78858-8,19420-9,19530-5,26747-6,40419-4,87762-1,3352-2,3939-6,19568-5,72782-6,56120-9,72462-5,72470-8,19651-9,19266-6,19267-4,3808-3,3941-2,19544-6,3786-1,8152-1,19418-3,3633-5,3436-3,87491-7,18414-3,19289-8,3426-4,79235-8,5608-5,3634-3,87484-2,43985-1,19269-0,42252-7,9726-1,19344-1,72805-5,16632-2,19542-0,79141-8,3627-7,72473-2,72783-4,72790-9,19428-2,20548-4,72463-3,79244-0,19291-4,19452-2,72804-8,19419-1,72791-7,78842-2,3393-6,19453-0,19408-4,19577-6,16214-9,26760-9,88022-9,16244-6,20526-0,19687-3,47400-7,50592-5,14308-1,19358-1,19455-5,3940-4,79243-2,19357-3,19543-8,43984-4,72792-5,3350-6,42860-7,72795-8,19685-7,12477-6,19559-4,78817-4,33507-5,19683-2,58357-5,19560-2,16492-1,86194-8,86191-4,3656-6,31016-9,3732-5,78840-6,79144-2,16448-3,3427-2,72472-4,19661-8,78881-0,17504-2,19424-1,87493-3,74001-9,27409-2,78838-0,73914-4,72465-8,61048-5,17872-3,3937-0,80144-9,70146-6,19293-0,3970-1,52957-8,3658-2,19381-3,8175-2,3566-7,19654-3,19360-7,52953-7,19423-3,86607-9,20554-2,72459-1,72875-8,13479-1,19410-0,78814-1,72460-9,19652-7,59329-3,12331-5,21386-8,19261-7,79242-4,78846-3,20525-2,19570-1,43983-6,72806-3,19557-8,3489-2,78880-2,19691-5,59135-4,87488-3,18389-7,72803-0,33280-9,78848-9,70145-8,73686-8,20543-5,19362-3,59287-3,87495-8,3780-4,72780-0,8192-7,19545-3,87490-9,3903-2,19690-7,73999-5,16254-5,21556-6,12296-0,19059-5,31026-8,72474-0,72817-0,3902-4,3657-4,19294-8,3629-3,73917-7,3810-9,19460-5,19422-5,19406-8,13498-1,70144-1,72794-1,19262-5,72793-3,78757-2,19686-5,5679-6,19343-3,19528-9,41464-9,20545-0,58925-9,19558-6,64233-0,19454-8,8237-0,12295-2,3398-5,3628-5,3809-1,20542-7,19531-3,72781-8,87489-1,19065-2,69798-7';
const item4_10 = '50542-0,19487-8,3871-1,13648-1,78861-2,19644-4,58396-3,66129-8,5706-7,12309-1,16253-7,3414-0,19437-3,75643-7,20527-8,72731-3,77777-1,58394-8,51448-9,49752-9,59673-4,11235-9,19532-1,18383-0,46971-8,72729-7,58393-0,3507-1,19593-3,70150-8,61424-8,58402-9,4077-4,26867-2,16998-7,65807-0,3540-2,8221-4,9835-0,19436-5,77787-0,65808-8,58430-0,19603-0,3879-4,86609-5,11073-4,3575-8,58384-9,72789-1,49831-1,19648-5,19609-7,72732-1,70197-9,58379-9,51739-1,58391-4,19550-3,79259-8,4075-8,58389-8,41465-6,16250-3,3618-6,19485-2,19450-6,58382-3,19613-9,70149-0,75362-4,19411-8,16246-1,74810-3,77879-5,19439-9,3829-9,78873-7,19138-7,3309-2,16208-1,19602-2,20551-8,19645-1,40839-3,78770-5,19297-1,14066-5,70151-6,19323-5,21431-2,78857-0,16249-5,3831-5,74817-8,58381-5,86608-7,58390-6,16252-9,19434-0,3573-3,19431-6,86604-6,78863-8,77779-7,41466-4,3839-8,19379-7,16196-8,60276-3,58387-2,16207-3,86193-0,51738-3,19636-0,70215-9,19534-7,82524-0,3310-0,19608-9,61197-0,19432-4,16851-8,3832-3,3546-9,10976-9,19302-9,58399-7,19600-6,3416-5,19516-4,19465-4,16334-5,19637-8,20550-0,19322-7,19299-7,78766-3,86610-3,77754-0,18334-3,3545-1,78768-9,19413-4,72485-6,78769-7,3619-4,3851-3,27920-8,18325-1,3830-7,19442-3,19296-3,16198-4,77207-9,19601-4,16213-1,3869-5,8220-6,42251-9,61421-4,74372-4,12333-1,58386-4,3747-3,16218-0,19646-9,58359-1,78828-1,16197-6,58398-9,61422-2,51954-6,19642-8,3774-7,19378-9,61420-6,58395-5,19632-9,42618-9,12308-3,12554-2,78868-7,59960-5,19597-4,19321-9,19605-5,47004-7,16242-0,16211-5,9396-3,19610-5,78864-6,64131-6,3547-7,19462-1,19448-0,3840-6,19607-1,19482-9,58383-1,19435-7,70210-0,51740-9,19380-5,58360-9,19535-4,3841-4,19414-2,16496-2,58392-2,3748-1,79240-8,18390-5,3311-8,19552-9,19449-8,3637-6,58388-0,58428-4,19650-1,79377-8,19464-7,43199-9,79260-6,58401-1,19451-4,46975-9,3773-9,3681-4,3842-2,78765-5,17384-9,19612-1,19429-0,19441-5,81754-4,19377-1,78874-5,17395-5,11246-6,51737-5,10998-3,19604-8,75649-4,33527-3,46973-4,3508-9,11075-9,3775-4,4076-6,52952-9,19486-0,61429-7,11247-4,77775-5,72384-1,19141-1,55520-1,16199-2,19643-6,19446-4,16755-1,3711-9,19484-5,19324-3,16200-8,77752-4,70147-4,38373-7,12395-0,19611-3,18435-8,82527-3,3712-7,70148-2,78862-0,18473-9,19518-0,20540-1,78865-3,74818-6,72730-5,16251-1,78767-1,70206-8,19635-2,3415-7,19599-0,19300-3,41858-2,58380-7,49829-5,17377-3,16749-4,58385-6,3357-1,16499-6,17376-5,3713-5,86197-1,19649-3,13641-6,43200-5,19295-5,51955-3,19553-7,73995-3,3541-0,58429-2,78830-7,52958-6,60514-7,9834-3,77764-9,51736-7,10975-1,61425-5,60126-0,19433-2,19463-9,3746-5,3574-1,19519-8,19438-1,19488-6,8222-2,3359-7';


function doCDSCall(collector) {
        return Promise.all([getCDSValues(collector)])
    }

    function getCDSValues(collector) {
    let pt = collector[0];

//    let prefetchData = getPrefetch(collector);//"{    \"hookInstance\": \"31c74cfc-747c-4afc-82e4-bdd3b7a0a58c\",    \"fhirServer\": \"http://localhost:8080/cqf-ruler-r4/fhir\",    \"hook\": \"patient-view\",    \"applyCql\": true,    \"context\": {        \"userId\": \"Practitioner/example\",        \"patientId\": \"Patient/example-rec-10-illicit-drugs\",        \"encounterId\": \"Encounter/example-rec-10-illicit-drugs-context\"    },    \"prefetch\": {        \"item1\": {            \"response\": {                \"status\": \"200 OK\"            },            \"resource\": {                \"resourceType\": \"Patient\",                \"id\": \"example-rec-10-illicit-drugs\",                \"gender\": \"female\",                \"birthDate\": \"1982-01-07\",                \"name\": [                    {                        \"family\": \"Smith\",                        \"given\": [                            \"John\",                            \"A.\"                        ]                    }                ]            }        },        \"item2\": {            \"response\": {                \"status\": \"200 OK\"            },            \"resource\": {                \"resourceType\": \"Bundle\",                \"entry\": [                    {                        \"resource\": {                            \"resourceType\": \"MedicationRequest\",                            \"id\": \"example-rec-10-illicit-drugs-prefetch\",                            \"status\": \"active\",                            \"intent\": \"order\",                            \"category\": [                                {                                    \"coding\": [                                        {                                            \"system\": \"http://terminology.hl7.org/CodeSystem/medicationrequest-category\",                                            \"code\": \"outpatient\"                                        }                                    ]                                }                            ],                            \"medicationCodeableConcept\": {                                \"coding\": [                                    {                                        \"system\": \"http://www.nlm.nih.gov/research/umls/rxnorm\",                                        \"code\": \"1049502\",                                        \"display\": \"12 HR Oxycodone Hydrochloride 10 MG Extended Release Oral Tablet\"                                    }                                ]                            },                            \"subject\": {                                \"reference\": \"Patient/example-rec-10-illicit-drugs\"                            },                            \"encounter\": {                                \"reference\": \"Encounter/example-rec-10-illicit-drugs-prefetch\"                            },                            \"_authoredOn\": {                                \"extension\": [                                    {                                        \"url\": \"http://hl7.org/fhir/StructureDefinition/cqf-expression\",                                        \"valueExpression\": {                                            \"language\": \"text/cql\",                                            \"expression\": \"Today() - 90 days\"                                        }                                    }                                ]                            },                            \"dosageInstruction\": [                                {                                    \"timing\": {                                        \"repeat\": {                                            \"frequency\": 3,                                            \"period\": 1.0,                                            \"periodUnit\": \"d\"                                        }                                    },                                    \"asNeededBoolean\": false,                                    \"doseAndRate\": [                                        {                                            \"doseQuantity\": {                                                \"value\": 1.0,                                                \"unit\": \"tablet\"                                            }                                        }                                    ]                                }                            ],                            \"dispenseRequest\": {                                \"_validityPeriod\": {                                    \"extension\": [                                        {                                            \"url\": \"http://hl7.org/fhir/StructureDefinition/cqf-expression\",                                            \"valueExpression\": {                                                \"language\": \"text/cql\",                                                \"expression\": \"FHIR.Period { start: FHIR.dateTime { value: Today() - 90 days }, end: FHIR.dateTime { value: Today() } }\"                                            }                                        }                                    ]                                },                                \"numberOfRepeatsAllowed\": 3,                                \"expectedSupplyDuration\": {                                    \"value\": 30.0,                                    \"unit\": \"d\"                                }                            }                        }                    },                    {                        \"resource\": {                            \"resourceType\": \"MedicationRequest\",                            \"id\": \"example-rec-10-illicit-drugs-context\",                            \"status\": \"active\",                            \"intent\": \"order\",                            \"category\": [                                {                                    \"coding\": [                                        {                                            \"system\": \"http://terminology.hl7.org/CodeSystem/medicationrequest-category\",                                            \"code\": \"outpatient\"                                        }                                    ]                                }                            ],                            \"medicationCodeableConcept\": {                                \"coding\": [                                    {                                        \"system\": \"http://www.nlm.nih.gov/research/umls/rxnorm\",                                        \"code\": \"197696\",                                        \"display\": \"72 HR Fentanyl 0.075 MG/HR Transdermal System\"                                    }                                ]                            },                            \"subject\": {                                \"reference\": \"Patient/example-rec-10-illicit-drugs\"                            },                            \"encounter\": {                                \"reference\": \"Encounter/example-rec-10-illicit-drugs-context\"                            },                            \"_authoredOn\": {                                \"extension\": [                                    {                                        \"url\": \"http://hl7.org/fhir/StructureDefinition/cqf-expression\",                                        \"valueExpression\": {                                            \"language\": \"text/cql\",                                            \"expression\": \"Today()\"                                        }                                    }                                ]                            },                            \"dosageInstruction\": [                                {                                    \"timing\": {                                        \"repeat\": {                                            \"frequency\": 1,                                            \"period\": 12.0,                                            \"periodUnit\": \"d\"                                        }                                    },                                    \"asNeededBoolean\": false,                                    \"doseAndRate\": [                                        {                                            \"doseQuantity\": {                                                \"value\": 1.0,                                                \"unit\": \"patch\"                                            }                                        }                                    ]                                }                            ],                            \"dispenseRequest\": {                                \"_validityPeriod\": {                                    \"extension\": [                                        {                                            \"url\": \"http://hl7.org/fhir/StructureDefinition/cqf-expression\",                                            \"valueExpression\": {                                                \"language\": \"text/cql\",                                                \"expression\": \"FHIR.Period { start: FHIR.dateTime { value: Today() }, end: FHIR.dateTime { value: Today() + 3 months } }\"                                            }                                        }                                    ]                                },                                \"numberOfRepeatsAllowed\": 3,                                \"expectedSupplyDuration\": {                                    \"value\": 30.0,                                    \"unit\": \"d\"                                }                            }                        }                    }                ]            }        },        \"item3\": {            \"response\": {                \"status\": \"200 OK\"            },            \"resource\": {                \"resourceType\": \"Observation\",                \"id\": \"example-rec-10-illicit-drugs-prefetch\",                \"status\": \"final\",                \"code\": {                    \"coding\": [                        {                            \"system\": \"http://loinc.org\",                            \"code\": \"3426-4\",                            \"display\": \"Tetrahydrocannabinol [Presence] in Urine\"                        }                    ]                },                \"subject\": {                    \"reference\": \"Patient/example-rec-10-illicit-drugs\"                },                \"_effectiveDateTime\": {                    \"extension\": [                        {                            \"url\": \"http://hl7.org/fhir/StructureDefinition/cqf-expression\",                            \"valueExpression\": {                                \"language\": \"text/cql\",                                \"expression\": \"Today() - 28 days\"                            }                        }                    ]                },                \"interpretation\": {                    \"coding\": [                        {                            \"system\": \"http://hl7.org/fhir/v2/0078\",                            \"code\": \"POS\"                        }                    ]                }            }        },        \"item4\": null    }}";
    let prefetchData = getPrefetch(collector);// + "\",\"encounterId\": \"Encounter/example-rec-10-illicit-drugs-context\"    },    \"prefetch\": {        \"item1\": {            \"response\": {                \"status\": \"200 OK\"            },            \"resource\": {                \"resourceType\": \"Patient\",                \"id\": \"example-rec-10-illicit-drugs\",                \"gender\": \"female\",                \"birthDate\": \"1982-01-07\",                \"name\": [                    {                        \"family\": \"Smith\",                        \"given\": [                            \"John\",                            \"A.\"                        ]                    }                ]            }        },        \"item2\": {            \"response\": {                \"status\": \"200 OK\"            },            \"resource\": {                \"resourceType\": \"Bundle\",                \"entry\": [                    {                        \"resource\": {                            \"resourceType\": \"MedicationRequest\",                            \"id\": \"example-rec-10-illicit-drugs-prefetch\",                            \"status\": \"active\",                            \"intent\": \"order\",                            \"category\": [                                {                                    \"coding\": [                                        {                                            \"system\": \"http://terminology.hl7.org/CodeSystem/medicationrequest-category\",                                            \"code\": \"outpatient\"                                        }                                    ]                                }                            ],                            \"medicationCodeableConcept\": {                                \"coding\": [                                    {                                        \"system\": \"http://www.nlm.nih.gov/research/umls/rxnorm\",                                        \"code\": \"1049502\",                                        \"display\": \"12 HR Oxycodone Hydrochloride 10 MG Extended Release Oral Tablet\"                                    }                                ]                            },                            \"subject\": {                                \"reference\": \"Patient/example-rec-10-illicit-drugs\"                            },                            \"encounter\": {                                \"reference\": \"Encounter/example-rec-10-illicit-drugs-prefetch\"                            },                            \"_authoredOn\": {                                \"extension\": [                                    {                                        \"url\": \"http://hl7.org/fhir/StructureDefinition/cqf-expression\",                                        \"valueExpression\": {                                            \"language\": \"text/cql\",                                            \"expression\": \"Today() - 90 days\"                                        }                                    }                                ]                            },                            \"dosageInstruction\": [                                {                                    \"timing\": {                                        \"repeat\": {                                            \"frequency\": 3,                                            \"period\": 1.0,                                            \"periodUnit\": \"d\"                                        }                                    },                                    \"asNeededBoolean\": false,                                    \"doseAndRate\": [                                        {                                            \"doseQuantity\": {                                                \"value\": 1.0,                                                \"unit\": \"tablet\"                                            }                                        }                                    ]                                }                            ],                            \"dispenseRequest\": {                                \"_validityPeriod\": {                                    \"extension\": [                                        {                                            \"url\": \"http://hl7.org/fhir/StructureDefinition/cqf-expression\",                                            \"valueExpression\": {                                                \"language\": \"text/cql\",                                                \"expression\": \"FHIR.Period { start: FHIR.dateTime { value: Today() - 90 days }, end: FHIR.dateTime { value: Today() } }\"                                            }                                        }                                    ]                                },                                \"numberOfRepeatsAllowed\": 3,                                \"expectedSupplyDuration\": {                                    \"value\": 30.0,                                    \"unit\": \"d\"                                }                            }                        }                    },                    {                        \"resource\": {                            \"resourceType\": \"MedicationRequest\",                            \"id\": \"example-rec-10-illicit-drugs-context\",                            \"status\": \"active\",                            \"intent\": \"order\",                            \"category\": [                                {                                    \"coding\": [                                        {                                            \"system\": \"http://terminology.hl7.org/CodeSystem/medicationrequest-category\",                                            \"code\": \"outpatient\"                                        }                                    ]                                }                            ],                            \"medicationCodeableConcept\": {                                \"coding\": [                                    {                                        \"system\": \"http://www.nlm.nih.gov/research/umls/rxnorm\",                                        \"code\": \"197696\",                                        \"display\": \"72 HR Fentanyl 0.075 MG/HR Transdermal System\"                                    }                                ]                            },                            \"subject\": {                                \"reference\": \"Patient/example-rec-10-illicit-drugs\"                            },                            \"encounter\": {                                \"reference\": \"Encounter/example-rec-10-illicit-drugs-context\"                            },                            \"_authoredOn\": {                                \"extension\": [                                    {                                        \"url\": \"http://hl7.org/fhir/StructureDefinition/cqf-expression\",                                        \"valueExpression\": {                                            \"language\": \"text/cql\",                                            \"expression\": \"Today()\"                                        }                                    }                                ]                            },                            \"dosageInstruction\": [                                {                                    \"timing\": {                                        \"repeat\": {                                            \"frequency\": 1,                                            \"period\": 12.0,                                            \"periodUnit\": \"d\"                                        }                                    },                                    \"asNeededBoolean\": false,                                    \"doseAndRate\": [                                        {                                            \"doseQuantity\": {                                                \"value\": 1.0,                                                \"unit\": \"patch\"                                            }                                        }                                    ]                                }                            ],                            \"dispenseRequest\": {                                \"_validityPeriod\": {                                    \"extension\": [                                        {                                            \"url\": \"http://hl7.org/fhir/StructureDefinition/cqf-expression\",                                            \"valueExpression\": {                                                \"language\": \"text/cql\",                                                \"expression\": \"FHIR.Period { start: FHIR.dateTime { value: Today() }, end: FHIR.dateTime { value: Today() + 3 months } }\"                                            }                                        }                                    ]                                },                                \"numberOfRepeatsAllowed\": 3,                                \"expectedSupplyDuration\": {                                    \"value\": 30.0,                                    \"unit\": \"d\"                                }                            }                        }                    }                ]            }        },        \"item3\": {            \"response\": {                \"status\": \"200 OK\"            },            \"resource\": {                \"resourceType\": \"Observation\",                \"id\": \"example-rec-10-illicit-drugs-prefetch\",                \"status\": \"final\",                \"code\": {                    \"coding\": [                        {                            \"system\": \"http://loinc.org\",                            \"code\": \"3426-4\",                            \"display\": \"Tetrahydrocannabinol [Presence] in Urine\"                        }                    ]                },                \"subject\": {                    \"reference\": \"Patient/example-rec-10-illicit-drugs\"                },                \"_effectiveDateTime\": {                    \"extension\": [                        {                            \"url\": \"http://hl7.org/fhir/StructureDefinition/cqf-expression\",                            \"valueExpression\": {                                \"language\": \"text/cql\",                                \"expression\": \"Today() - 28 days\"                            }                        }                    ]                },                \"interpretation\": {                    \"coding\": [                        {                            \"system\": \"http://hl7.org/fhir/v2/0078\",                            \"code\": \"POS\"                        }                    ]                }            }        },        \"item4\": null    }}";
    let prefetchData2 = '{  "hookInstance": "b266185d-c26a-40dd-a024-70b5b6222170",  "fhirServer": "http://localhost:8080/cqf-ruler-dstu3/fhir",  "hook": "patient-view",  "applyCql": true,  "context": {    "userId": "Practitioner/example",    "patientId": "Patient/example-rec-11-benzo-trigger-with-opioid",    "encounterId": "Encounter/example-rec-11-benzo-trigger-with-opioid-context"  },  "prefetch": {    "item1": {      "response": {        "status": "200 OK"      },      "resource": {        "resourceType": "Patient",        "id": "example-rec-11-benzo-trigger-with-opioid",        "gender": "female",        "birthDate": "1982-01-07"      }    },    "item2": {      "response": {        "status": "200 OK"      },      "resource": {        "resourceType": "MedicationRequest",        "id": "example-rec-11-benzo-trigger-with-opioid-context",        "status": "active",        "intent": "order",        "category": [          {            "coding": [              {                "system": "http://terminology.hl7.org/CodeSystem/medicationrequest-category",                "code": "outpatient"              }            ]          }        ],        "medicationCodeableConcept": {          "coding": [            {              "system": "http://www.nlm.nih.gov/research/umls/rxnorm",              "code": "1298088",              "display": "Flurazepam Hydrochloride 15 MG Oral Capsule"            }          ]        },        "subject": {          "reference": "Patient/example-rec-11-benzo-trigger-with-opioid"        },        "encounter": {          "reference": "Encounter/example-rec-11-benzo-trigger-with-opioid-context"        },        "_authoredOn": {          "extension": [            {              "url": "http://hl7.org/fhir/StructureDefinition/cqf-expression",              "valueExpression": {                "language": "text/cql",                "expression": "Today()"              }            }          ]        },        "dosageInstruction": [          {            "timing": {              "repeat": {                "frequency": 1,                "period": 1.0,                "periodUnit": "d"              }            },            "asNeededBoolean": false,            "doseAndRate": [              {                "doseQuantity": {                  "value": 1.0,                  "unit": "capsule"                }              }            ]          }        ],        "dispenseRequest": {          "_validityPeriod": {            "extension": [              {                "url": "http://hl7.org/fhir/StructureDefinition/cqf-expression",                "valueExpression": {                  "language": "text/cql",                  "expression": "FHIR.Period { start: FHIR.dateTime { value: Today() }, end: FHIR.dateTime { value: Today() + 3 months } }"                }              }            ]          },          "numberOfRepeatsAllowed": 3,          "expectedSupplyDuration": {            "value": 30.0,            "unit": "d"          }        }      }    },    "item3": {      "response": {        "status": "200 OK"      },      "resource": {        "resourceType": "MedicationRequest",        "id": "example-rec-11-benzo-trigger-with-opioid-prefetch",        "status": "active",        "intent": "order",        "category": [          {            "coding": [              {                "system": "http://terminology.hl7.org/CodeSystem/medicationrequest-category",                "code": "outpatient"              }            ]          }        ],        "medicationCodeableConcept": {          "coding": [            {              "system": "http://www.nlm.nih.gov/research/umls/rxnorm",              "code": "1049502",              "display": "12 HR Oxycodone Hydrochloride 10 MG Extended Release Oral Tablet"            }          ]        },        "subject": {          "reference": "Patient/example-rec-11-benzo-trigger-with-opioid"        },        "encounter": {          "reference": "Encounter/example-rec-11-benzo-trigger-with-opioid-prefetch"        },        "_authoredOn": {          "extension": [            {              "url": "http://hl7.org/fhir/StructureDefinition/cqf-expression",              "valueExpression": {                "language": "text/cql",                "expression": "Today() - 28 days"              }            }          ]        },        "dosageInstruction": [          {            "timing": {              "repeat": {                "frequency": 1,                "period": 1.0,                "periodUnit": "d"              }            },            "asNeededBoolean": false,            "doseAndRate": [              {                "doseQuantity": {                  "value": 1.0,                  "unit": "tablet"                }              }            ]          }        ],        "dispenseRequest": {          "_validityPeriod": {            "extension": [              {                "url": "http://hl7.org/fhir/StructureDefinition/cqf-expression",                "valueExpression": {                  "language": "text/cql",                  "expression": "FHIR.Period { start: FHIR.dateTime { value: Today() - 28 days }, end: FHIR.dateTime { value: Today() + 3 months } }"                }              }            ]          },          "numberOfRepeatsAllowed": 3,          "expectedSupplyDuration": {            "value": 30.0,            "unit": "d"          }        }      }    }  }}';
    let prefetchData3 = '{  "hookInstance": "b266185d-c26a-40dd-a024-70b5b6222170",  "fhirServer": "http://localhost:8080/cqf-ruler-dstu3/fhir",  "hook": "patient-view",  "applyCql": true,  "context": {    "user": "Practitioner/example",    "patientId": "Patient/example-rec-11-benzo-trigger-with-opioid",    "encounterId": "Encounter/example-rec-11-benzo-trigger-with-opioid-context"  },  "prefetch": {    "item1": {      "response": {        "status": "200 OK"      },      "resource": {        "resourceType": "Patient",        "id": "example-rec-11-benzo-trigger-with-opioid",        "gender": "female",        "birthDate": "1982-01-07"      }    },    "item2": {      "response": {        "status": "200 OK"      },      "resource": {        "resourceType": "Bundle",        "entry": [          {            "resource": {              "resourceType": "MedicationRequest",              "id": "example-rec-11-benzo-trigger-with-opioid-context",              "status": "active",              "intent": "order",              "category": {                "coding": [                  {                    "system": "http://hl7.org/fhir/medication-request-category",                    "code": "community"                  }                ]              },              "medicationCodeableConcept": {                "coding": [                  {                    "system": "http://www.nlm.nih.gov/research/umls/rxnorm",                    "code": "1298088",                    "display": "Flurazepam Hydrochloride 15 MG Oral Capsule"                  }                ]              },              "subject": {                "reference": "Patient/example-rec-11-benzo-trigger-with-opioid"              },              "context": {                "reference": "Encounter/example-rec-11-benzo-trigger-with-opioid-context"              },              "_authoredOn": {                "extension": [                  {                    "url": "http://hl7.org/fhir/StructureDefinition/cqif-cqlExpression",                    "valueString": "Today()"                  }                ]              },              "dosageInstruction": [                {                  "timing": {                    "repeat": {                      "frequency": 1,                      "period": 1.0,                      "periodUnit": "d"                    }                  },                  "asNeededBoolean": false,                  "doseQuantity": {                    "value": 1.0,                    "unit": "capsule"                  }                }              ],              "dispenseRequest": {                "validityPeriod": {                  "extension": [                    {                      "url": "http://hl7.org/fhir/StructureDefinition/cqif-cqlExpression",                      "valueString": "FHIR.Period { start: FHIR.dateTime { value: Today() }, end: FHIR.dateTime { value: Today() + 3 months } }"                    }                  ]                },                "numberOfRepeatsAllowed": 3,                "expectedSupplyDuration": {                  "value": 30.0,                  "unit": "d"                }              }            }          },          {            "resource": {              "resourceType": "MedicationRequest",              "id": "example-rec-11-benzo-trigger-with-opioid-prefetch",              "status": "active",              "intent": "order",              "category": {                "coding": [                  {                    "system": "http://hl7.org/fhir/medication-request-category",                    "code": "community"                  }                ]              },              "medicationCodeableConcept": {                "coding": [                  {                    "system": "http://www.nlm.nih.gov/research/umls/rxnorm",                    "code": "1049502",                    "display": "12 HR Oxycodone Hydrochloride 10 MG Extended Release Oral Tablet"                  }                ]              },              "subject": {                "reference": "Patient/example-rec-11-benzo-trigger-with-opioid"              },              "context": {                "reference": "Encounter/example-rec-11-benzo-trigger-with-opioid-prefetch"              },              "_authoredOn": {                "extension": [                  {                    "url": "http://hl7.org/fhir/StructureDefinition/cqif-cqlExpression",                    "valueString": "Today() - 28 days"                  }                ]              },              "dosageInstruction": [                {                  "timing": {                    "repeat": {                      "frequency": 1,                      "period": 1.0,                      "periodUnit": "d"                    }                  },                  "asNeededBoolean": false,                  "doseQuantity": {                    "value": 1.0,                    "unit": "tablet"                  }                }              ],              "dispenseRequest": {                "validityPeriod": {                  "extension": [                    {                      "url": "http://hl7.org/fhir/StructureDefinition/cqif-cqlExpression",                      "valueString": "FHIR.Period { start: FHIR.dateTime { value: Today() - 28 days }, end: FHIR.dateTime { value: Today() + 3 months } }"                    }                  ]                },                "numberOfRepeatsAllowed": 3,                "expectedSupplyDuration": {                  "value": 30.0,                  "unit": "d"                }              }            }          }        ]      }    }  }}';
        let url = 'http://localhost:8080/cqf-ruler-dstu3/cds-services/opioidcds-10-patient-view';
        let url2 = 'http://localhost:8080/cqf-ruler-dstu3/cds-services/opioidcds-11-patient-view'
        return fetch(url2, {
                method: 'POST',     // use GET for cds-services discovery call
                body: prefetchData3, // string or object  !!put back in for POST operation
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.text())
            .then(response => {
                console.log(response);
                return JSON.parse(response);})
            .then(response => {
                let returnText = '';
                if(response.cards.length > 0) {
                    returnText = response.cards[0].summary;
                    if (response.cards[0].detail) {
                        returnText += '.     ' + response.cards[0].detail;
                    }
                }
                return returnText;
            })
            .catch(error => {
            console.log(error);
            console.log("The call to the ruler failed.");
        });
    }

    function getPrefetch(collector){
        let prefetchStr = getHeader10();
        let pt = collector[0];
        prefetchStr = prefetchStr + pt.url + '"}, "prefetch": {"item1":' + JSON.stringify(pt.data) + ",";
        collector.forEach(entry =>{
            let entryCount3 = 0;
            let entryCount4 = 0;
            //item3 & 4
            if(entry.url.startsWith('https://launch.smarthealthit.org/v/r4/fhir/Observation?')){
                let obsBundle = JSON.stringify(entry.data);
                let obsObject = JSON.parse(obsBundle);
                let item3Entries = '';
                let item4Entries = '';
                obsObject.entry.forEach(obsObjectEntry=>{
                    if(codeInList(obsObjectEntry.resource.code.coding[0].code + ',', item3_10)){
                        entryCount3++;
                        item3Entries = item3Entries + JSON.stringify(obsObjectEntry) + ',';
                    }
                    if(codeInList(obsObjectEntry.resource.code.coding[0].code + ',', item4_10)){
                        entryCount4++;
                        item4Entries = item4Entries + JSON.stringify(obsObjectEntry) + ',';
                    }
                });
                if(entryCount3 > 0){
                    item3Entries = item3Entries.substring(0, item3Entries.length - 1);
                    prefetchStr = prefetchStr + '"item3":{"resourceType":"Bundle","entry":[' + item3Entries + ']},';
                }else{
                    prefetchStr = prefetchStr + '"item3":null,';
                }
                if(entryCount4 > 0){
                    item4Entries = item4Entries.substring(0, item4Entries.length - 1);
                    prefetchStr = prefetchStr + '"item4":{"resourceType":"Bundle","entry":[' + item4Entries + ']},';
                }else{
                    prefetchStr = prefetchStr + '"item4":null,';
                }
            }
            //item2
            if(entry.url.startsWith('https://launch.smarthealthit.org/v/r4/fhir/MedicationRequest?')){
                let medReqBundle = JSON.stringify(entry.data);
                let medReqObject = JSON.parse(medReqBundle);
                let item2Entries = '';
                let entryCount = 0;
                medReqObject.entry.forEach(medReqObjectEntry=>{
                    if(codeInList(medReqObjectEntry.resource.medicationCodeableConcept.coding[0].code + ',', item2_10)){
                        entryCount++;
                        item2Entries = item2Entries + JSON.stringify(medReqObjectEntry) + ',';
                    }
                });
                if(entryCount > 0){
                    item2Entries = item2Entries.substring(0, item2Entries.length - 1);
                    prefetchStr = prefetchStr + '"item2":{"resourceType":"Bundle","entry":[' + item2Entries + ']},';
                }else{
                    prefetchStr = prefetchStr + '"item2":null,';
                }
            }
        })
        if(prefetchStr.charAt(prefetchStr.length - 1) === ','){
            prefetchStr = prefetchStr.substring(0, prefetchStr.length - 1);
        }
        prefetchStr = prefetchStr + '}}';//'"item4":null}}'
        //close json object
console.log(prefetchStr);
        return prefetchStr;
    }

    function getHeader10(){
        return '{"hookInstance": "31c74cfc-747c-4afc-82e4-bdd3b7a0a58c","fhirServer": "http://localhost:8080/cqf-ruler-r4/fhir","hook": "patient-view","applyCql": true,"context": {"userId": "Practitioner/PainManager","patientId": "';
    }

    function codeInList(codeItem, whichList){
        if (whichList.indexOf(codeItem) > -1){
            return true;
        };
        return false;
    }
    export default doCDSCall;


//        let url = "http://ec2-54-149-75-236.us-west-2.compute.amazonaws.com:8080/ruleexecutor/cds-services/HIMSSCKDIdUrgentCareDR2";
//        let url = "https://fhir-org-cds-services.appspot.com/cds-service/patient-greeting";
//        let url = 'https://fhir.alphora.com/cqf-ruler/cds-services';
//        let url = 'http://localhost:8080/cqf-ruler-r4/cds-services/patient-greeting';
//        let url = 'https://fhir-org-cds-services.appspot.com/cds-services'
//        let url = "https://fhir-org-cds-services.appspot.com/cds-service/patient-greeting";
